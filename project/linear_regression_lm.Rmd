---
title: "Regression lm"
author: "Abhigyan Kishor"
date: "2023-11-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This example uses the `tidyverse` suite of packages.

```{r, load_tidyverse}
library(tidyverse)
library(ggplot2)
```

### Read data

The code chunk below reads in the final project data.

```{r, read_final_data}
df <- readr::read_csv("paint_project_train_data.csv", col_names = TRUE)
```

```{r, show_data_glimpse}
df %>% glimpse()
```

## Phase 2: Regression (linear models)

We first perform the logit transform and store results in `df_scaled`. Do logit then standardize.

```{r}
df_scaled <- df %>%
  mutate(y = boot::logit( (response - 0) / (100 - 0) ) ) %>%
  mutate(R = (R - mean(R)) / sd(R)) %>%
  mutate(G = (G - mean(G)) / sd(G)) %>%
  mutate(B = (B - mean(B)) / sd(B)) %>%
  mutate(Hue = (Hue - mean(Hue)) / sd(Hue)) %>%
  select(R, G, B, Hue, Saturation, Lightness, y)
```

#### Linear models (lm)

Here, I make a list of formulas to then create the model and result tables programmatically.

```{r}
lm_models <- tibble(
  formula = c(
    "y ~ 1",
    "y ~ Lightness + Saturation",
    "y ~ R + G + B + Hue",
    "y ~ .",
    "y ~ (Lightness + Saturation)*(R + G + B + Hue)",
    "y ~ Lightness + Saturation + (R + G + B + Hue)*(R + G + B + Hue)",
    "y ~ (Lightness + Saturation)*(R + G + B + Hue)*(R + G + B + Hue)",
    "y ~ (Lightness)*(Saturation)*(R + G + B + Hue)*(R + G + B + Hue)",
    "y ~ Lightness + Saturation + R + G + B + Hue + I(R^2) + I(G^2) + I(B^2) + I(Hue^2)",
    "y ~ splines::ns(R + G + B, 4)"
  )
)
```

A helper function to store `lm()` results.

```{r}
formula_to_lm_model <- function(form_str) {
  form <- as.formula(form_str)
  lm(form, data = df_scaled)
}
```

I create the models and then create `glance()` values. Finally add names for book-keeping later.

```{r}
lm_models <- lm_models %>% 
  mutate(models = purrr::map(formula, formula_to_lm_model)) %>% 
  mutate(model_glance = map(models, broom::glance)) %>% 
  unnest(model_glance) %>% 
  mutate(names = c('a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j'))
```

I chose AIC metric to compare the models.

```{r}
lm_models %>% arrange((AIC))  
```

I choose the top 3 models.

```{r}
top_lm_models <- lm_models %>% arrange((AIC)) %>% head(3) 
```

```{r}
top_lm_models %>% select(formula)
```

A helper function to get most significant coefficients using `summary()`.

```{r}
get_sig_coefs <- function(model) {
  (model %>%
    summary())$coefficients %>%
    as.data.frame() %>%
    rownames_to_column(var = "coef_name") %>% 
    as_tibble() %>%
    filter(`Pr(>|t|)` < 0.05)  
}
```

I create coefficient plots to show the most estimate and deviation in the most significant coefficients. I filter the most important coefficients by statistical significance to improve readability.

```{r}
top_lm_models %>% 
  mutate(sig_coefs = purrr::map(models, get_sig_coefs)) %>%
  unnest(sig_coefs) %>%
  mutate(min1sd = Estimate - `Std. Error`) %>%
  mutate(max1sd = Estimate + `Std. Error`) %>%
  mutate(min2sd = Estimate - 2*`Std. Error`) %>%
  mutate(max2sd = Estimate + 2*`Std. Error`) %>%
  filter(max2sd * min2sd > 0) %>%   #they have the same sign = statistically significant
  ggplot(mapping = aes(x = Estimate, y = coef_name)) +
  geom_point(size = 1.5, color = 'blue') +
  geom_errorbarh(aes(xmin = min2sd, xmax = max2sd), color = 'blue', size = 0.5, height = 0) +
  geom_errorbarh(aes(xmin = min1sd, xmax = max1sd), color = 'blue', size = 1, height = 0) +
  geom_vline(xintercept = 0, linetype = 'dashed', color = 'gray', size = 1) +
  xlab('Value') + 
  ylab('Coefficient') + 
  labs(title = 'Coefficient Plot') +
  facet_wrap(~ names)
```

The best coefficients according to P value.

```{r}
top_lm_models %>% 
  mutate(sig_coefs = purrr::map(models, get_sig_coefs)) %>%
  unnest(sig_coefs) %>%
  mutate(min1sd = Estimate - `Std. Error`) %>%
  mutate(max1sd = Estimate + `Std. Error`) %>%
  mutate(min2sd = Estimate - 2*`Std. Error`) %>%
  mutate(max2sd = Estimate + 2*`Std. Error`) %>%
  filter(max2sd * min2sd > 0) %>%  
  arrange(`Pr(>|t|)`) %>%
  mutate(coef_name = paste(coef_name, '_', names)) %>% 
  head(10) %>% 
  select(coef_name)
  
```

```{r}
top_lm_models$models[top_lm_models$formula == 'y ~ (Lightness + Saturation)*(R + G + B + Hue)'][[1]] %>% stats::sigma()
```
